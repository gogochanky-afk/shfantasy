<!-- /public/draft.html -->
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>SH Fantasy - Draft</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: Arial; background:#111; color:#fff; padding:20px; }
    .top { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; }
    .badge { background:#222; padding:8px 12px; border-radius:999px; font-size:14px; }
    .card { background:#1e1e1e; padding:14px; border-radius:12px; margin:12px 0; }
    button { background:orange; border:none; padding:10px 14px; border-radius:8px; cursor:pointer; }
    button:disabled { opacity:.4; cursor:not-allowed; }
    .player { display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid #2a2a2a; }
    .player:last-child { border-bottom:none; }
    .ok { color:#0f0; }
    .bad { color:#f33; }
    a { color:orange; text-decoration:none; }
  </style>
</head>
<body>
  <div class="top">
    <div class="badge">Mode: <span id="mode">DEMO</span> ¬∑ User: <span id="user">-</span></div>
    <div><a href="/my-entries">My Entries ‚Üí</a></div>
  </div>

  <h1>üìù Draft Lineup</h1>
  <div class="card">
    <div>Pool: <b id="poolId">-</b> ¬∑ Entry: <b id="entryId">-</b></div>
    <div style="margin-top:8px;">
      Salary Cap: <b>10</b> ¬∑ Pick exactly: <b>5</b>
    </div>
    <div style="margin-top:8px;">
      Total Cost: <b id="totalCost">0</b>
      <span id="capStatus" class="ok">(OK)</span>
    </div>
    <div style="margin-top:10px;">
      <button id="saveBtn" disabled>Save Lineup</button>
      <button id="clearBtn" style="margin-left:8px;background:#444;">Clear</button>
      <a href="/" style="margin-left:12px;">‚Üê Back</a>
    </div>
  </div>

  <div class="card">
    <h3>Players</h3>
    <div id="players"></div>
  </div>

<script>
  const qs = new URLSearchParams(location.search);
  const entryId = qs.get('entryId');
  const poolId = qs.get('poolId');

  const user = localStorage.getItem('shf_username') || '';
  document.getElementById('user').textContent = user || '-';
  document.getElementById('entryId').textContent = entryId || '-';
  document.getElementById('poolId').textContent = poolId || '-';

  if (!entryId || !poolId || !user) {
    alert("Missing entryId/poolId/user. Go back and Join first.");
  }

  let selected = new Set();

  function render(players) {
    const container = document.getElementById('players');
    container.innerHTML = '';

    const totalCost = players
      .filter(p => selected.has(p.id))
      .reduce((sum, p) => sum + p.cost, 0);

    document.getElementById('totalCost').textContent = totalCost;

    const capStatus = document.getElementById('capStatus');
    const saveBtn = document.getElementById('saveBtn');

    const ok = (selected.size === 5 && totalCost <= 10);
    capStatus.textContent = ok ? '(OK)' : '(Need 5 picks & <= 10)';
    capStatus.className = ok ? 'ok' : 'bad';
    saveBtn.disabled = !ok;

    players.forEach(p => {
      const row = document.createElement('div');
      row.className = 'player';
      const checked = selected.has(p.id);

      row.innerHTML = `
        <div>
          <label>
            <input type="checkbox" ${checked ? 'checked' : ''} data-id="${p.id}" />
            ${p.name}
          </label>
        </div>
        <div>Cost: <b>${p.cost}</b></div>
      `;
      container.appendChild(row);
    });

    container.querySelectorAll('input[type="checkbox"]').forEach(cb => {
      cb.addEventListener('change', (e) => {
        const id = e.target.getAttribute('data-id');
        if (e.target.checked) {
          selected.add(id);
        } else {
          selected.delete(id);
        }
        render(players);
      });
    });
  }

  async function loadPlayersAndExistingLineup() {
    const pres = await fetch('/api/players');
    const pdata = await pres.json();
    const players = pdata.players || [];

    // try load existing lineup
    const lres = await fetch(`/api/lineup?entryId=${encodeURIComponent(entryId)}`);
    const ldata = await lres.json();
    if (ldata && ldata.lineup && Array.isArray(ldata.lineup.players)) {
      selected = new Set(ldata.lineup.players);
    }

    render(players);

    document.getElementById('saveBtn').onclick = async () => {
      const body = {
        entryId: Number(entryId),
        poolId,
        username: user,
        players: Array.from(selected)
      };
      const res = await fetch('/api/lineup', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      const data = await res.json();
      if (!res.ok) {
        alert(data.error || 'Save failed');
        return;
      }
      alert('Saved! Total cost = ' + data.totalCost);
      location.href = '/my-entries';
    };

    document.getElementById('clearBtn').onclick = () => {
      selected = new Set();
      render(players);
    };
  }

  loadPlayersAndExistingLineup();
</script>
</body>
</html>
