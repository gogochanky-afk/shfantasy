<!-- /public/draft.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Draft ¬∑ SH Fantasy</title>
  <style>
    :root { color-scheme: dark; }
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial;background:#0b0c0f;color:#eaeaea;}
    .wrap{max-width:720px;margin:0 auto;padding:18px;}
    .nav{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;gap:12px;}
    .brand{font-weight:800;font-size:20px;}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
    .pill{border:1px solid #2b2b2e;border-radius:999px;padding:8px 10px;font-size:12px;color:#cfcfcf;background:#101114;}
    .btn{background:#f0a500;border:none;border-radius:10px;padding:10px 14px;font-weight:800;color:#111;cursor:pointer;}
    .btn.secondary{background:transparent;border:1px solid #2b2b2e;color:#eaeaea;}
    .btn:disabled{opacity:.45;cursor:not-allowed;}
    .card{background:#141416;border:1px solid #242427;border-radius:16px;padding:14px;margin-top:12px;}
    .title{font-weight:800;font-size:18px;margin:0 0 6px;}
    .muted{color:#b7b7bd;font-size:12px;}
    .list{margin-top:10px;}
    .item{display:flex;justify-content:space-between;align-items:center;padding:10px 10px;border:1px solid #242427;border-radius:14px;background:#101114;margin-bottom:8px;}
    .left{display:flex;flex-direction:column;gap:2px;}
    .name{font-weight:800;}
    .sub{font-size:12px;color:#b7b7bd;}
    input[type="checkbox"]{transform:scale(1.2);}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:24px;background:#1b1c20;border:1px solid #303036;color:#fff;padding:10px 12px;border-radius:12px;font-size:13px;opacity:0;pointer-events:none;transition:opacity .15s;}
    .toast.show{opacity:1;}
    a{color:#f0a500;text-decoration:none;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="nav">
      <div class="brand">üß† Draft</div>
      <div class="row">
        <button class="btn secondary" id="backBtn">‚Üê Back</button>
        <a class="pill" href="/my-entries.html">üìí My Entries</a>
      </div>
    </div>

    <div class="card">
      <div class="title">Select Players</div>
      <div class="muted" id="hint">Loading‚Ä¶</div>
      <div style="height:10px"></div>
      <div class="row">
        <div class="pill" id="userPill">User: ‚Äî</div>
        <div class="pill" id="poolPill">Pool: ‚Äî</div>
        <div class="pill" id="selPill">Selected: 0/5</div>
        <div class="pill" id="costPill">Cost: 0/10</div>
      </div>
      <div style="height:10px"></div>
      <div class="row">
        <button class="btn" id="saveBtn" disabled>Save Lineup</button>
        <button class="btn secondary" id="resetBtn">Reset</button>
      </div>
      <div class="muted" style="margin-top:10px" id="ruleText">Pick players to enable Save.</div>
      <div class="list" id="list"></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const toastEl = $('toast');
  let toastTimer = null;

  function toast(msg){
    toastEl.textContent = msg;
    toastEl.classList.add('show');
    clearTimeout(toastTimer);
    toastTimer = setTimeout(()=>toastEl.classList.remove('show'), 1800);
  }

  function getUsername(){
    return (localStorage.getItem('shf_username') || '').trim();
  }

  function qs(name){
    return new URLSearchParams(window.location.search).get(name);
  }

  const entryId = (qs('entryId') || '').trim();
  let rosterSize = 5;
  let salaryCap = 10;
  let poolId = '';
  let username = getUsername();

  let players = [];
  let selected = new Set();

  $('backBtn').addEventListener('click', ()=>{ window.location.href = '/'; });
  $('resetBtn').addEventListener('click', ()=>{
    selected = new Set();
    renderList();
    updatePills();
  });

  function updatePills(){
    $('userPill').textContent = 'User: ' + (username || '‚Äî');
    $('poolPill').textContent = 'Pool: ' + (poolId || '‚Äî');
    $('selPill').textContent = `Selected: ${selected.size}/${rosterSize}`;
    const cost = calcCost();
    $('costPill').textContent = `Cost: ${cost}/${salaryCap}`;

    const ok = (selected.size === rosterSize) && (cost <= salaryCap);
    $('saveBtn').disabled = !ok;
    $('ruleText').textContent = ok
      ? 'Ready to save.'
      : `Pick exactly ${rosterSize} players. Stay within salary cap ${salaryCap}.`;
  }

  function calcCost(){
    let c = 0;
    for(const id of selected){
      const p = players.find(x=>x.id===id);
      if(p) c += Number(p.cost)||0;
    }
    return c;
  }

  function renderList(){
    const list = $('list');
    list.innerHTML = '';
    for(const p of players){
      const div = document.createElement('div');
      div.className = 'item';
      const checked = selected.has(p.id) ? 'checked' : '';
      div.innerHTML = `
        <div class="left">
          <div class="name">${escapeHtml(p.name)} <span class="muted">¬∑ ${escapeHtml(p.team)}</span></div>
          <div class="sub">Cost: ${p.cost}</div>
        </div>
        <div>
          <input type="checkbox" data-id="${escapeAttr(p.id)}" ${checked}/>
        </div>
      `;
      const cb = div.querySelector('input[type="checkbox"]');
      cb.addEventListener('change', (e)=>{
        const id = e.target.getAttribute('data-id');
        if(e.target.checked){
          // soft-enforce roster size
          if(selected.size >= rosterSize){
            e.target.checked = false;
            toast(`Max ${rosterSize} players.`);
            return;
          }
          selected.add(id);
        }else{
          selected.delete(id);
        }
        // salary cap warning only
        const cost = calcCost();
        if(cost > salaryCap) toast(`Over cap: ${cost}/${salaryCap}`);
        updatePills();
      });
      list.appendChild(div);
    }
  }

  async function loadAll(){
    // hard guard
    if(!entryId){
      toast('Missing entryId. Going home‚Ä¶');
      setTimeout(()=>window.location.href='/', 600);
      return;
    }
    if(!username){
      toast('No username. Go back to Home.');
      setTimeout(()=>window.location.href='/', 600);
      return;
    }

    try{
      $('hint').textContent = 'Loading entry‚Ä¶';
      const er = await fetch('/api/lineup?entryId=' + encodeURIComponent(entryId), { cache:'no-store' });
      const ej = await er.json();
      if(!ej.ok) throw new Error(ej.message || ej.error || 'Entry not found');

      poolId = (ej.entry && ej.entry.poolId) || '';
      rosterSize = (ej.pool && ej.pool.rosterSize) || rosterSize;
      salaryCap = (ej.pool && ej.pool.salaryCap) || salaryCap;

      // restore selected
      selected = new Set(((ej.entry && ej.entry.players) || []).map(String));

      $('hint').textContent = 'Loading players‚Ä¶';
      const pr = await fetch('/api/players', { cache:'no-store' });
      const pj = await pr.json();
      if(!pj.ok) throw new Error(pj.message || pj.error || 'Players load failed');

      players = pj.players || [];
      if(!players.length) throw new Error('No players');

      $('hint').textContent = `Exactly ${rosterSize} players ¬∑ Salary cap ${salaryCap}`;
      renderList();
      updatePills();

    }catch(e){
      $('hint').textContent = 'Load failed.';
      toast('Load failed: ' + (e.message || 'error'));
    }
  }

  async function saveLineup(){
    try{
      const payload = { entryId, players: Array.from(selected) };
      const r = await fetch('/api/lineup', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload),
      });
      const j = await r.json();
      if(!j.ok) throw new Error(j.message || j.error || 'Save failed');
      toast('Saved!');
      // optional: go entries
      // setTimeout(()=>window.location.href='/my-entries.html', 500);
    }catch(e){
      toast('Save failed: ' + (e.message || 'error'));
    }
  }

  $('saveBtn').addEventListener('click', saveLineup);

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }
  function escapeAttr(s){ return escapeHtml(s); }

  // init
  $('userPill').textContent = 'User: ' + (username || '‚Äî');
  loadAll();
})();
</script>
</body>
</html>
