<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Draft · SH Fantasy</title>
  <style>
    :root{color-scheme:dark;}
    *{box-sizing:border-box;margin:0;padding:0;}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;background:#0b0c0f;color:#eaeaea;}
    .wrap{max-width:720px;margin:0 auto;padding:20px 16px;}
    .nav{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;}
    .nav a{color:#888;font-size:13px;text-decoration:none;}
    .nav a:hover{color:#eaeaea;}
    h1{font-size:22px;font-weight:800;margin-bottom:4px;}
    .sub{color:#888;font-size:13px;margin-bottom:16px;}
    .status-bar{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:20px;font-size:13px;}
    .pill{background:#1e2028;border:1px solid #2a2d35;border-radius:6px;padding:4px 10px;}
    .pill span{font-weight:700;}
    .pill.ok span{color:#4ade80;}
    .section-title{font-size:11px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:#666;margin-bottom:8px;}
    .player-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:8px;margin-bottom:20px;}
    .player-card{background:#16181d;border:1px solid #2a2d35;border-radius:8px;padding:12px;cursor:pointer;transition:border-color .15s,background .15s;}
    .player-card:hover{border-color:#3b82f6;}
    .player-card.selected{border-color:#3b82f6;background:#0d1a2e;}
    .player-card.disabled{opacity:.4;cursor:not-allowed;}
    .player-name{font-weight:700;font-size:14px;margin-bottom:4px;}
    .player-meta{font-size:12px;color:#888;}
    .player-cost{font-size:13px;font-weight:700;color:#3b82f6;margin-top:4px;}
    .status-badge{display:inline-block;font-size:10px;font-weight:700;border-radius:3px;padding:1px 5px;margin-left:5px;vertical-align:middle;line-height:1.4;}
    .status-badge.q{background:#78350f;color:#fbbf24;border:1px solid #92400e;}
    .status-badge.unk{background:#1e293b;color:#94a3b8;border:1px solid #334155;}
    .roster-list{margin-bottom:20px;}
    .roster-item{display:flex;justify-content:space-between;align-items:center;background:#16181d;border:1px solid #2a2d35;border-radius:6px;padding:10px 14px;margin-bottom:6px;}
    .roster-name{font-weight:600;font-size:14px;}
    .roster-meta{font-size:12px;color:#888;}
    .roster-remove{background:none;border:none;color:#f87171;cursor:pointer;font-size:18px;padding:0 4px;}
    .btn{padding:10px 22px;border-radius:6px;font-size:14px;font-weight:600;cursor:pointer;border:none;background:#3b82f6;color:#fff;transition:background .15s;}
    .btn:hover{background:#2563eb;}
    .btn:disabled{background:#333;color:#666;cursor:not-allowed;}
    .btn-ghost{background:transparent;border:1px solid #2a2d35;color:#888;}
    .btn-ghost:hover{border-color:#555;color:#eaeaea;background:transparent;}
    .toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:#1e2028;border:1px solid #2a2d35;border-radius:8px;padding:10px 20px;font-size:14px;z-index:999;opacity:0;transition:opacity .2s;}
    .toast.show{opacity:1;}
    .empty{text-align:center;color:#555;padding:32px 0;font-size:14px;}
    .spinner{display:inline-block;width:16px;height:16px;border:2px solid #444;border-top-color:#3b82f6;border-radius:50%;animation:spin .6s linear infinite;}
    @keyframes spin{to{transform:rotate(360deg);}}
  </style>
</head>
<body>
<div class="wrap">
  <nav class="nav">
    <a href="/">&larr; Home</a>
    <a href="/my-entries.html">My Entries</a>
  </nav>
  <h1 id="pool-title">Draft</h1>
  <p class="sub" id="pool-sub"></p>
  <div class="status-bar">
    <div class="pill"><span id="cap-display">Cap: 0/10</span></div>
    <div class="pill"><span id="roster-display">Roster: 0/5</span></div>
    <div class="pill" id="mode-pill"><span id="mode-display">...</span></div>
    <div class="pill"><span id="updated-display" style="color:#666;font-size:11px;"></span></div>
  </div>
  <div class="section-title">Your Roster</div>
  <div id="roster-list" class="roster-list">
    <div class="empty" style="padding:16px 0;font-size:13px;">No players selected yet.</div>
  </div>
  <div style="margin-bottom:20px;display:flex;gap:8px;flex-wrap:wrap;">
    <button id="save-btn" class="btn" onclick="saveLineup()" disabled>Save Lineup</button>
    <button class="btn btn-ghost" onclick="clearRoster()">Clear</button>
  </div>
  <div class="section-title">Available Players</div>
  <div id="player-grid" class="player-grid">
    <div class="empty"><span class="spinner"></span> Loading players...</div>
  </div>
</div>
<div id="toast" class="toast"></div>
<script>
(function(){
  var qs=new URLSearchParams(location.search);
  var poolId=qs.get("poolId")||"";
  var entryId=qs.get("entryId")||"";
  if(!poolId||!entryId){
    document.getElementById("pool-sub").textContent="Missing poolId or entryId.";
    document.getElementById("player-grid").innerHTML="";
    return;
  }
  document.getElementById("pool-sub").textContent="Pool: "+poolId+" · Entry: "+entryId;
  var ROSTER_SIZE=5,SALARY_CAP=10,roster=[],allPlayers=[];
  fetch("/api/players?poolId="+encodeURIComponent(poolId),{cache:"no-store"})
    .then(function(r){return r.json();})
    .then(function(d){
      if(!d.ok||!d.players||d.players.length===0){
        document.getElementById("player-grid").innerHTML='<div class="empty">No players found.</div>';
        return;
      }
      allPlayers=d.players;
      var mode=d.dataMode||"SNAPSHOT";
      document.getElementById("mode-display").textContent="DATA: "+mode;
      document.getElementById("updated-display").textContent=d.updatedAt?"Updated: "+new Date(d.updatedAt).toLocaleTimeString():"";
      if(mode==="SNAPSHOT"||mode==="LIVE") document.getElementById("mode-pill").className="pill ok";
      renderGrid();
    })
    .catch(function(e){
      document.getElementById("player-grid").innerHTML='<div class="empty">Error: '+e.message+'</div>';
    });
  function renderGrid(){
    var rIds=roster.map(function(p){return p.id;});
    var usedCap=roster.reduce(function(s,p){return s+p.cost;},0);
    var html="";
    allPlayers.forEach(function(p){
      var inR=rIds.indexOf(p.id)!==-1;
      var dis=!inR&&(usedCap+p.cost>SALARY_CAP||roster.length>=ROSTER_SIZE);
      var cls="player-card"+(inR?" selected":"")+(dis?" disabled":"");
      var pj=JSON.stringify(JSON.stringify(p));
      var badge='';
      if(p.injuryStatus==='questionable'){badge='<span class="status-badge q">Q</span>';}
      else if(p.injuryStatus==='unknown'){badge='<span class="status-badge unk">?</span>';}
      html+='<div class="'+cls+'" onclick="togglePlayer('+pj+')">';
      html+='<div class="player-name">'+esc(p.name)+badge+'</div>';
      html+='<div class="player-meta">'+esc(p.team)+' · '+esc(p.position)+'</div>';
      html+='<div class="player-cost">$'+p.cost+'</div>';
      html+='</div>';
    });
    document.getElementById("player-grid").innerHTML=html||'<div class="empty">No players.</div>';
    renderRoster();updateStatus();
  }
  function renderRoster(){
    if(roster.length===0){document.getElementById("roster-list").innerHTML='<div class="empty" style="padding:16px 0;font-size:13px;">No players selected yet.</div>';return;}
    var html="";
    roster.forEach(function(p){
      var pj=JSON.stringify(JSON.stringify(p));
      html+='<div class="roster-item"><div><div class="roster-name">'+esc(p.name)+'</div><div class="roster-meta">'+esc(p.team)+' · '+esc(p.position)+' · $'+p.cost+'</div></div><button class="roster-remove" onclick="removePlayer('+pj+')">&times;</button></div>';
    });
    document.getElementById("roster-list").innerHTML=html;
  }
  function updateStatus(){
    var usedCap=roster.reduce(function(s,p){return s+p.cost;},0);
    document.getElementById("cap-display").textContent="Cap: "+usedCap+"/"+SALARY_CAP;
    document.getElementById("roster-display").textContent="Roster: "+roster.length+"/"+ROSTER_SIZE;
    document.getElementById("save-btn").disabled=(roster.length===0);
  }
  window.togglePlayer=function(pj){
    var p=JSON.parse(pj);
    var idx=roster.findIndex(function(r){return r.id===p.id;});
    if(idx!==-1){roster.splice(idx,1);}
    else{
      var usedCap=roster.reduce(function(s,r){return s+r.cost;},0);
      if(roster.length>=ROSTER_SIZE){showToast("Roster full ("+ROSTER_SIZE+" max)");return;}
      if(usedCap+p.cost>SALARY_CAP){showToast("Over salary cap ($"+SALARY_CAP+")");return;}
      roster.push(p);
    }
    renderGrid();
  };
  window.removePlayer=function(pj){var p=JSON.parse(pj);roster=roster.filter(function(r){return r.id!==p.id;});renderGrid();};
  window.clearRoster=function(){roster=[];renderGrid();showToast("Roster cleared");};
  window.saveLineup=function(){
    if(roster.length===0){showToast("Add players first");return;}
    var lineups=JSON.parse(localStorage.getItem("shf_lineups")||"{}");
    lineups[entryId]={poolId:poolId,players:roster.map(function(p){return p.id;}),playerDetails:roster,savedAt:new Date().toISOString()};
    localStorage.setItem("shf_lineups",JSON.stringify(lineups));
    showToast("Lineup saved! \u2713");
    var btn=document.getElementById("save-btn");
    btn.textContent="Saved \u2713";
    setTimeout(function(){btn.textContent="Save Lineup";},2000);
  };
  function showToast(msg){var t=document.getElementById("toast");t.textContent=msg;t.classList.add("show");setTimeout(function(){t.classList.remove("show");},2500);}
  function esc(s){return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");}
})();
</script>
</body>
</html>