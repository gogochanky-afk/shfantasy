<!-- file: public/draft.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Draft ¬∑ SH Fantasy</title>
  <style>
    :root { color-scheme: dark; }
    body { margin:0; font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial; background:#0b0b0c; color:#fff; }
    .wrap { max-width:720px; margin:0 auto; padding:18px; }
    .nav { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:14px; }
    .brand { font-weight:800; letter-spacing:.2px; }
    .btn { background:#f0a500; color:#111; border:none; padding:10px 14px; border-radius:10px; font-weight:800; cursor:pointer; }
    .btn.secondary { background:transparent; color:#fff; border:1px solid #2b2b2e; }
    .btn:disabled { opacity:.45; cursor:not-allowed; }
    .card { background:#141416; border:1px solid #1f1f22; border-radius:16px; padding:16px; margin-top:14px; }
    .muted { color:#b7b7bd; font-size:12px; }
    .pill { border:1px solid #2b2b2e; padding:6px 10px; border-radius:999px; font-size:12px; color:#d2d2d7; background:#111113; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:10px; }
    .list { margin-top:12px; display:flex; flex-direction:column; gap:8px; }
    .item { display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px; background:#0f0f11; border:1px solid #2b2b2e; border-radius:12px; }
    .left { display:flex; flex-direction:column; gap:2px; }
    .name { font-weight:800; }
    .meta { font-size:12px; color:#b7b7bd; }
    .toast { position:fixed; left:50%; transform:translateX(-50%); bottom:26px; background:#1b1b1f; border:1px solid #2b2b2e; color:#fff; padding:10px 14px; border-radius:12px; font-size:13px; display:none; z-index:9999; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="nav">
      <div class="brand">üß† Draft</div>
      <div class="row" style="margin:0;">
        <button class="btn secondary" onclick="goHome()">‚Üê Back</button>
        <button class="btn secondary" onclick="goMyEntries()">üóÇÔ∏è My Entries</button>
      </div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 6px 0;">Select Players</h3>
      <div class="muted">Exactly <span id="rosterSizeTxt">5</span> players ¬∑ Salary cap <span id="salaryCapTxt">10</span></div>
      <div class="row" style="margin-top:12px;">
        <div class="pill" id="userPill">User: ‚Äî</div>
        <div class="pill" id="poolPill">Pool: ‚Äî</div>
        <div class="pill" id="selPill">Selected: 0/5</div>
        <div class="pill" id="costPill">Cost: 0/10</div>
      </div>
      <div class="row">
        <button class="btn" id="saveBtn" onclick="saveLineup()" disabled>Save Lineup</button>
        <button class="btn secondary" onclick="resetPick()">Reset</button>
      </div>
      <div class="muted" id="hintTxt" style="margin-top:8px;">Pick players to enable Save.</div>

      <div class="list" id="playersList"></div>
    </div>

    <div class="toast" id="toast"></div>
  </div>

  <script>
    function toast(msg) {
      const t = document.getElementById("toast");
      t.textContent = msg;
      t.style.display = "block";
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(() => t.style.display = "none", 2200);
    }

    function goHome(){ window.location.href = "/"; }
    function goMyEntries(){ window.location.href = "/my-entries.html"; }

    function getUsername() {
      return (localStorage.getItem("shf_username") || "").trim();
    }

    function qparam(name) {
      const u = new URL(window.location.href);
      return u.searchParams.get(name);
    }

    let entryId = null;
    let poolId = null;
    let salaryCap = 10;
    let rosterSize = 5;

    let players = [];
    let selected = new Set();

    function updateHeader() {
      const u = getUsername();
      document.getElementById("userPill").textContent = `User: ${u || "‚Äî"}`;
      document.getElementById("poolPill").textContent = `Pool: ${poolId || "‚Äî"}`;
      document.getElementById("rosterSizeTxt").textContent = String(rosterSize);
      document.getElementById("salaryCapTxt").textContent = String(salaryCap);

      const cost = calcCost();
      document.getElementById("selPill").textContent = `Selected: ${selected.size}/${rosterSize}`;
      document.getElementById("costPill").textContent = `Cost: ${cost}/${salaryCap}`;

      const canSave = (selected.size === rosterSize) && (cost <= salaryCap);
      document.getElementById("saveBtn").disabled = !canSave;
      document.getElementById("hintTxt").textContent = canSave ? "Ready to save." : "Pick players to enable Save.";
    }

    function calcCost() {
      let total = 0;
      for (const pid of selected) {
        const p = players.find(x => x.id === pid);
        if (p) total += Number(p.cost || 0);
      }
      return total;
    }

    function togglePick(pid) {
      if (selected.has(pid)) {
        selected.delete(pid);
        renderList();
        updateHeader();
        return;
      }
      // prevent picking beyond rosterSize
      if (selected.size >= rosterSize) {
        toast(`You can only pick ${rosterSize} players.`);
        return;
      }
      selected.add(pid);
      renderList();
      updateHeader();
    }

    function resetPick() {
      selected = new Set();
      renderList();
      updateHeader();
    }

    function renderList() {
      const el = document.getElementById("playersList");
      el.innerHTML = "";

      for (const p of players) {
        const picked = selected.has(p.id);

        const row = document.createElement("div");
        row.className = "item";

        const left = document.createElement("div");
        left.className = "left";

        const name = document.createElement("div");
        name.className = "name";
        name.textContent = p.name;

        const meta = document.createElement("div");
        meta.className = "meta";
        meta.textContent = `${p.team || "‚Äî"} ¬∑ Cost ${p.cost}`;

        left.appendChild(name);
        left.appendChild(meta);

        const btn = document.createElement("button");
        btn.className = "btn secondary";
        btn.textContent = picked ? "Remove" : "Pick";
        btn.onclick = () => togglePick(p.id);

        row.appendChild(left);
        row.appendChild(btn);
        el.appendChild(row);
      }
    }

    async function loadPlayers() {
      const r = await fetch("/api/players", { cache: "no-store" });
      const j = await r.json();
      if (!j.ok) throw new Error(j.error || "Failed to load players");
      players = j.players || [];
      if (!players.length) throw new Error("No players available");
    }

    async function loadEntry() {
      // This endpoint must exist in backend: /api/lineup?entryId=...
      const r = await fetch(`/api/lineup?entryId=${encodeURIComponent(entryId)}`, { cache: "no-store" });
      const j = await r.json();
      if (!j.ok) throw new Error(j.error || "Entry not found");

      // Expect entry + pool in response
      poolId = (j.entry && j.entry.poolId) ? j.entry.poolId : (j.pool && j.pool.id) ? j.pool.id : null;

      // Use server truth for caps
      if (j.pool && typeof j.pool.salaryCap !== "undefined") salaryCap = Number(j.pool.salaryCap);
      if (j.pool && typeof j.pool.rosterSize !== "undefined") rosterSize = Number(j.pool.rosterSize);

      // Preselect if lineup exists
      const picked = (j.entry && Array.isArray(j.entry.players)) ? j.entry.players : [];
      selected = new Set(picked);
    }

    async function saveLineup() {
      const u = getUsername();
      if (!u) { toast("No username. Go back to Home."); return; }
      if (!entryId) { toast("Missing entryId."); return; }

      const payload = {
        entryId,
        poolId,
        username: u,
        players: Array.from(selected)
      };

      const btn = document.getElementById("saveBtn");
      btn.disabled = true;
      btn.textContent = "Saving‚Ä¶";

      try {
        const r = await fetch("/api/lineup", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        const j = await r.json();
        if (!j.ok) throw new Error(j.error || "Save failed");

        toast("Saved ‚úÖ");
        btn.textContent = "Save Lineup";
        updateHeader();
      } catch (e) {
        toast(String(e.message || e));
        btn.textContent = "Save Lineup";
        updateHeader();
      }
    }

    async function init() {
      entryId = qparam("entryId");
      if (!entryId) {
        toast("Missing entryId. Returning Home‚Ä¶");
        setTimeout(() => goHome(), 700);
        return;
      }

      // Require username exist (same device storage)
      const u = getUsername();
      if (!u) {
        toast("No username. Returning Home‚Ä¶");
        setTimeout(() => goHome(), 700);
        return;
      }

      try {
        await loadPlayers();
        await loadEntry();
        renderList();
        updateHeader();
      } catch (e) {
        toast(String(e.message || e));
      }
    }

    init();
  </script>
</body>
</html>
