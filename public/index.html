<!-- /public/index.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SH Fantasy ¬∑ Arena</title>
  <style>
    :root { color-scheme: dark; }
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial;background:#0b0c0f;color:#eaeaea;}
    .wrap{max-width:720px;margin:0 auto;padding:18px;}
    .nav{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;gap:12px;}
    .brand{font-weight:800;font-size:20px;line-height:1.2;}
    .pill{border:1px solid #2b2b2e;border-radius:999px;padding:8px 10px;font-size:12px;color:#cfcfcf;background:#101114;}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
    .btn{background:#f0a500;border:none;border-radius:10px;padding:10px 14px;font-weight:700;color:#111;cursor:pointer;}
    .btn.secondary{background:transparent;border:1px solid #2b2b2e;color:#eaeaea;}
    .btn:disabled{opacity:.45;cursor:not-allowed;}
    .card{background:#141416;border:1px solid #242427;border-radius:16px;padding:14px;margin-top:12px;}
    .title{font-weight:800;font-size:18px;margin:0 0 6px;}
    .muted{color:#b7b7bd;font-size:12px;}
    input{width:100%;box-sizing:border-box;background:#0f1012;border:1px solid #2b2b2e;color:#eaeaea;padding:12px 12px;border-radius:12px;font-size:16px;}
    .poolRow{display:flex;justify-content:space-between;align-items:center;gap:10px;}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:24px;background:#1b1c20;border:1px solid #303036;color:#fff;padding:10px 12px;border-radius:12px;font-size:13px;opacity:0;pointer-events:none;transition:opacity .15s;}
    .toast.show{opacity:1;}
    a{color:#f0a500;text-decoration:none;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="nav">
      <div class="brand">üî• SH Fantasy<br/>Arena</div>
      <div class="row">
        <div class="pill" id="modePill">Mode: ...</div>
        <div class="pill" id="userPill">User: ‚Äî</div>
        <a class="pill" href="/my-entries.html">üìí My Entries</a>
      </div>
    </div>

    <div class="card">
      <div class="title">Start</div>
      <div class="muted">Enter your username once. We save it on this device.</div>
      <div style="height:10px"></div>
      <input id="username" placeholder="e.g. Hugo" />
      <div style="height:10px"></div>
      <div class="row">
        <button class="btn" id="saveBtn">Save Username</button>
        <button class="btn secondary" id="clearBtn">Clear</button>
      </div>
    </div>

    <div class="card">
      <div class="title">Pools</div>
      <div class="muted" id="poolsHint">Loading‚Ä¶</div>
      <div id="pools" style="margin-top:12px"></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const toastEl = $('toast');
  let toastTimer = null;

  // ---- Storage keys (stable) ----
  const K_USERNAME = 'shf_username';
  const K_POOL_ID  = 'shf_poolId';
  const K_ENTRY_ID = 'shf_entryId';

  function toast(msg){
    toastEl.textContent = msg;
    toastEl.classList.add('show');
    clearTimeout(toastTimer);
    toastTimer = setTimeout(()=>toastEl.classList.remove('show'), 1800);
  }

  function getUsername(){
    return (localStorage.getItem(K_USERNAME) || '').trim();
  }
  function setUsername(u){
    localStorage.setItem(K_USERNAME, u);
  }
  function clearUsername(){
    localStorage.removeItem(K_USERNAME);
  }
  function setLastJoinState({ poolId, entryId, username }){
    if (username) localStorage.setItem(K_USERNAME, username);
    if (poolId)  localStorage.setItem(K_POOL_ID, poolId);
    if (entryId) localStorage.setItem(K_ENTRY_ID, entryId);
  }

  function setUserPill(){
    const u = getUsername();
    $('userPill').textContent = 'User: ' + (u || '‚Äî');
  }

  async function loadMode(){
    try{
      // ‚úÖ ‰Ω† server ‰øÇ /healthzÔºàÂîî‰øÇ /healthÔºâ
      const r = await fetch('/healthz', { cache:'no-store' });
      const j = await r.json();
      if (j && j.ok) $('modePill').textContent = 'Mode: LIVE';
      else $('modePill').textContent = 'Mode: ‚Äî';
    }catch(e){
      $('modePill').textContent = 'Mode: ‚Äî';
    }
  }

  function fmtLock(lockAt){
    if(!lockAt) return '';
    const t = new Date(lockAt);
    if(isNaN(t.getTime())) return '';
    return 'Lock: ' + t.toLocaleString();
  }

  function normPool(p){
    // ÂÖºÂÆπÂîîÂêå schemaÔºöname/title ÈÉΩÊé•Âèó
    const id = p.id;
    const name = p.name || p.title || p.id;
    const lockAt = p.lockAt;
    const salaryCap = (p.salaryCap ?? 10);
    const rosterSize = (p.rosterSize ?? 5);
    const locked = !!p.locked || p.status === 'locked' || p.status === 'closed';
    return { id, name, lockAt, salaryCap, rosterSize, locked };
  }

  async function loadPools(){
    $('poolsHint').textContent = 'Loading‚Ä¶';
    $('pools').innerHTML = '';
    try{
      const r = await fetch('/api/pools', { cache:'no-store' });
      const j = await r.json();
      if(!j.ok) throw new Error(j.error || 'pools failed');
      const pools = (j.pools || []).map(normPool);

      if(!pools.length){
        $('poolsHint').textContent = 'No pools right now.';
        return;
      }

      $('poolsHint').textContent = 'Pick a pool to join.';
      for(const p of pools){
        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `
          <div class="poolRow">
            <div>
              <div class="title">${escapeHtml(p.name)} ${p.locked ? '<span class="muted">¬∑ Locked</span>' : ''}</div>
              <div class="muted">Salary Cap: ${escapeHtml(String(p.salaryCap))} ¬∑ Roster Size: ${escapeHtml(String(p.rosterSize))}</div>
              <div class="muted">${escapeHtml(fmtLock(p.lockAt))}</div>
              <div class="muted">Join will take you directly to Draft.</div>
            </div>
            <button class="btn" data-pool="${escapeAttr(p.id)}" ${p.locked ? 'disabled' : ''}>Join</button>
          </div>
        `;
        div.querySelector('button').addEventListener('click', ()=>joinPool(p.id));
        $('pools').appendChild(div);
      }
    }catch(e){
      $('poolsHint').textContent = 'Pools unavailable';
      toast('Pools unavailable');
    }
  }

  async function joinPool(poolId){
    const u = getUsername();
    if(!u){
      toast('Please save username first.');
      return;
    }
    try{
      const r = await fetch('/api/join', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ username:u, poolId }),
      });
      const j = await r.json();
      if(!j.ok) throw new Error(j.error || 'join failed');

      const entryId = j.entryId;
      const returnedPoolId = j.poolId || poolId;

      if(!entryId) throw new Error('Missing entryId from server');

      // ‚úÖ 1) persist state (hard refresh ‰ªçÁÑ∂Êúâ)
      setLastJoinState({ poolId: returnedPoolId, entryId, username: u });

      // ‚úÖ 2) redirect Â∏∂ÈΩä poolId + entryIdÔºåDraft Â∞±ÂîîÊúÉÂÜç Pool: ‚Äî
      const url = '/draft.html'
        + '?poolId=' + encodeURIComponent(returnedPoolId)
        + '&entryId=' + encodeURIComponent(entryId);

      window.location.href = url;
    }catch(e){
      toast('Join failed: ' + (e.message || 'error'));
    }
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }
  function escapeAttr(s){ return escapeHtml(s); }

  // init
  $('username').value = getUsername();
  $('saveBtn').addEventListener('click', ()=>{
    const u = $('username').value.trim();
    if(!u){ toast('Username is required'); return; }
    setUsername(u);
    setUserPill();
    toast('Saved');
  });
  $('clearBtn').addEventListener('click', ()=>{
    clearUsername();
    $('username').value = '';
    setUserPill();
    toast('Cleared');
  });

  setUserPill();
  loadMode();
  loadPools();
})();
</script>
</body>
</html>
