<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>SH Fantasy</title>
  <style>
    :root{color-scheme:dark;}
    *{box-sizing:border-box;margin:0;padding:0;}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;background:#0b0c0f;color:#eaeaea;min-height:100vh;}
    .wrap{max-width:640px;margin:0 auto;padding:24px 16px;}
    h1{font-size:28px;font-weight:800;letter-spacing:-0.5px;margin-bottom:4px;}
    .sub{color:#888;font-size:14px;margin-bottom:24px;}
    .badge{display:inline-block;padding:2px 8px;border-radius:4px;font-size:12px;font-weight:700;background:#1e3a1e;color:#4ade80;margin-bottom:20px;}
    .section-title{font-size:12px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:#666;margin-bottom:10px;}
    .card{background:#16181d;border:1px solid #2a2d35;border-radius:10px;padding:16px;margin-bottom:12px;}
    .card-title{font-weight:700;font-size:16px;margin-bottom:6px;}
    .card-meta{font-size:13px;color:#888;margin-bottom:12px;}
    .lock{font-size:12px;color:#f59e0b;}
    .btn{display:inline-block;padding:8px 18px;border-radius:6px;font-size:14px;font-weight:600;cursor:pointer;border:none;background:#3b82f6;color:#fff;transition:background .15s;}
    .btn:hover{background:#2563eb;}
    .btn:disabled{background:#333;color:#666;cursor:not-allowed;}
    .input{width:100%;padding:10px 12px;border-radius:6px;border:1px solid #2a2d35;background:#1e2028;color:#eaeaea;font-size:14px;margin-bottom:12px;}
    .input:focus{outline:none;border-color:#3b82f6;}
    .error{color:#f87171;font-size:13px;margin-top:8px;}
    .spinner{display:inline-block;width:16px;height:16px;border:2px solid #444;border-top-color:#3b82f6;border-radius:50%;animation:spin .6s linear infinite;}
    @keyframes spin{to{transform:rotate(360deg);}}
    .nav{display:flex;justify-content:space-between;align-items:center;margin-bottom:28px;}
    .nav a{color:#888;font-size:13px;text-decoration:none;}
    .nav a:hover{color:#eaeaea;}
    .team-badge{background:#1e2028;padding:3px 8px;border-radius:4px;font-size:12px;}
    .empty{text-align:center;color:#555;padding:32px 0;font-size:14px;}
  </style>
</head>
<body>
<div class="wrap">
  <nav class="nav">
    <span style="font-weight:800;font-size:18px;">SH Fantasy</span>
    <a href="/my-entries.html">My Entries</a>
  </nav>
  <h1>Pick Your Pool</h1>
  <p class="sub">Join a pool, draft your lineup, win.</p>
  <div id="mode-badge" class="badge">...</div>
  <div id="pools-section">
    <div class="empty"><span class="spinner"></span> Loading pools...</div>
  </div>
  <div id="join-form" style="display:none;" class="card">
    <div class="section-title">Join Pool</div>
    <div id="join-pool-label" style="font-weight:600;margin-bottom:12px;"></div>
    <input id="username-input" class="input" type="text" placeholder="Your username" maxlength="30"/>
    <button id="join-btn" class="btn" onclick="doJoin()">Join &amp; Draft</button>
    <div id="join-error" class="error"></div>
  </div>
</div>
<script>
(function(){
  var selectedPool = null;
  var saved = localStorage.getItem("shf_username");
  if (saved) document.getElementById("username-input").value = saved;
  fetch("/healthz").then(function(r){return r.json();}).then(function(d){
    var el = document.getElementById("mode-badge");
    el.textContent = "DATA MODE: "+(d.dataMode||d.mode||"SNAPSHOT");
  }).catch(function(){});
  fetch("/api/pools",{cache:"no-store"}).then(function(r){return r.json();}).then(function(d){
    if(!d.ok||!d.pools||d.pools.length===0){
      document.getElementById("pools-section").innerHTML='<div class="empty">No pools available right now.</div>';
      return;
    }
    renderPools(d.pools);
  }).catch(function(e){
    document.getElementById("pools-section").innerHTML='<div class="empty">Failed to load pools: '+e.message+'</div>';
  });
  function renderPools(pools){
    var html='<div class="section-title">Available Pools</div>';
    pools.forEach(function(p){
      var lock=p.lockAt?new Date(p.lockAt).toLocaleString():"TBD";
      var pj=JSON.stringify(JSON.stringify(p));
      html+='<div class="card" style="cursor:pointer;" onclick="selectPool('+pj+')" id="pool-'+p.id+'">';
      html+='<div class="card-title">'+esc(p.label||p.title||p.id)+'</div>';
      html+='<div class="card-meta"><span class="team-badge">'+esc(p.homeTeam||"")+'</span> vs <span class="team-badge">'+esc(p.awayTeam||"")+'</span></div>';
      html+='<div class="lock">&#x1F512; Locks: '+esc(lock)+'</div>';
      html+='<div style="margin-top:10px;"><button class="btn" onclick="event.stopPropagation();selectPool('+pj+')" style="font-size:13px;padding:6px 14px;">Select</button></div>';
      html+='</div>';
    });
    document.getElementById("pools-section").innerHTML=html;
  }
  window.selectPool=function(pj){
    selectedPool=JSON.parse(pj);
    document.querySelectorAll(".card").forEach(function(el){el.style.borderColor="#2a2d35";});
    var el=document.getElementById("pool-"+selectedPool.id);
    if(el)el.style.borderColor="#3b82f6";
    document.getElementById("join-pool-label").textContent=selectedPool.label||selectedPool.title||selectedPool.id;
    document.getElementById("join-form").style.display="block";
    document.getElementById("join-error").textContent="";
    document.getElementById("username-input").focus();
  };
  window.doJoin=function(){
    var username=document.getElementById("username-input").value.trim();
    var btn=document.getElementById("join-btn");
    if(!username){document.getElementById("join-error").textContent="Please enter a username.";return;}
    if(!selectedPool){document.getElementById("join-error").textContent="Please select a pool.";return;}
    localStorage.setItem("shf_username",username);
    btn.disabled=true;btn.textContent="Joining...";
    fetch("/api/join",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:username,poolId:selectedPool.id})})
      .then(function(r){return r.json();}).then(function(d){
        if(!d.ok){document.getElementById("join-error").textContent=d.error||"Join failed.";btn.disabled=false;btn.textContent="Join & Draft";return;}
        var entries=JSON.parse(localStorage.getItem("shf_entries")||"[]");
        entries.push({entryId:d.entryId,poolId:d.poolId,username:username,poolLabel:selectedPool.label||selectedPool.title||selectedPool.id,joinedAt:new Date().toISOString()});
        localStorage.setItem("shf_entries",JSON.stringify(entries));
        window.location.href="/draft.html?poolId="+encodeURIComponent(d.poolId)+"&entryId="+encodeURIComponent(d.entryId);
      }).catch(function(e){
        document.getElementById("join-error").textContent="Network error: "+e.message;
        btn.disabled=false;btn.textContent="Join & Draft";
      });
  };
  function esc(s){return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");}
})();
</script>
</body>
</html>