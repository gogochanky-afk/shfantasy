<!DOCTYPE html>
<html>
<head>
  <title>SH Fantasy Arena</title>
  <style>
    body {
      font-family: Arial;
      background: #111;
      color: white;
      padding: 20px;
    }

    .card {
      background: #222;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 8px;
    }

    button {
      background: orange;
      border: none;
      padding: 8px 12px;
      cursor: pointer;
      margin-top: 8px;
    }

    .player {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
    }

    .salary-ok {
      color: #0f0;
    }

    .salary-bad {
      color: red;
    }
  </style>
</head>
<body>

<h1>ðŸ”¥ SH Fantasy Arena</h1>

<div id="main"></div>

<script>
let currentEntryId = null;
let currentPoolId = null;
let currentUsername = null;
let selectedPlayers = [];

//
// ===== INITIAL SCREEN =====
//
function showHome() {
  document.getElementById("main").innerHTML = `
    <div class="card">
      <h3>Today Arena</h3>
      <p>Salary Cap: 10</p>
      <p>Roster Size: 5</p>
      <button onclick="join('demo-today')">Join</button>
    </div>
  `;
}

//
// ===== JOIN =====
//
async function join(poolId) {
  const username = prompt("Enter your name:");
  if (!username) return;

  const res = await fetch("/api/join", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ poolId, username })
  });

  const data = await res.json();

  currentEntryId = data.entryId;
  currentPoolId = poolId;
  currentUsername = username;

  loadPlayers();
}

//
// ===== LOAD PLAYERS =====
//
async function loadPlayers() {
  const res = await fetch("/api/players");
  const data = await res.json();

  const players = data.players;

  let html = `
    <div class="card">
      <h2>Select 5 Players</h2>
      <div id="salary">Salary: 0 / 10</div>
  `;

  players.forEach(p => {
    html += `
      <div class="player">
        <span>${p.name} (${p.cost})</span>
        <input type="checkbox" value="${p.id}" 
          onchange="togglePlayer('${p.id}', ${p.cost})">
      </div>
    `;
  });

  html += `
      <button onclick="saveLineup()">Save Lineup</button>
    </div>
  `;

  document.getElementById("main").innerHTML = html;
}

//
// ===== TOGGLE PLAYER =====
//
function togglePlayer(id, cost) {
  if (selectedPlayers.includes(id)) {
    selectedPlayers = selectedPlayers.filter(p => p !== id);
  } else {
    selectedPlayers.push(id);
  }

  updateSalary();
}

//
// ===== UPDATE SALARY =====
//
function updateSalary() {
  let total = 0;

  document.querySelectorAll("input[type=checkbox]").forEach(cb => {
    if (cb.checked) {
      const cost = parseInt(cb.parentElement.innerText.match(/\((\d+)\)/)[1]);
      total += cost;
    }
  });

  const salaryDiv = document.getElementById("salary");

  if (total > 10 || selectedPlayers.length > 5) {
    salaryDiv.className = "salary-bad";
  } else {
    salaryDiv.className = "salary-ok";
  }

  salaryDiv.innerText = `Salary: ${total} / 10`;
}

//
// ===== SAVE LINEUP =====
//
async function saveLineup() {
  if (selectedPlayers.length !== 5) {
    alert("You must select exactly 5 players");
    return;
  }

  const res = await fetch("/api/lineup", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      entryId: currentEntryId,
      poolId: currentPoolId,
      username: currentUsername,
      players: selectedPlayers
    })
  });

  const data = await res.json();

  if (data.ok) {
    alert("Lineup Saved! ðŸ’ª");
    showHome();
  } else {
    alert(data.error);
  }
}

showHome();
</script>

</body>
</html>
