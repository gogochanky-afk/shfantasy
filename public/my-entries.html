<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SH Fantasy - My Entries</title>
  <style>
    body{font-family:Arial;background:#111;color:#fff;padding:20px}
    .header{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
    .pill{background:#222;border-radius:999px;padding:8px 12px;display:inline-block}
    .btn{background:transparent;border:1px solid orange;color:orange;border-radius:999px;padding:10px 14px;cursor:pointer}
    .btnSolid{background:orange;border:none;color:#111;border-radius:10px;padding:10px 14px;cursor:pointer}
    .card{background:#1b1b1b;border-radius:12px;padding:14px;margin-top:12px}
    .muted{opacity:.75}
    .row{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .small{font-size:12px;opacity:.85}
    a{color:orange}
  </style>
</head>
<body>
  <div class="header">
    <div>
      <div style="font-size:22px;font-weight:700;">üìí My Entries</div>
      <div class="muted small">Demo mode / localStorage username fallback</div>
    </div>
    <div class="row">
      <span class="pill" id="modePill">Mode: -</span>
      <span class="pill" id="userPill">User: -</span>
      <button class="btn" onclick="goHome()">‚Üê Back</button>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <div>
        <div style="font-weight:700;">Load Entries</div>
        <div class="muted small">If no username found, we will ask once and save it.</div>
      </div>
      <button class="btnSolid" onclick="load()">Refresh</button>
    </div>
  </div>

  <div id="list"></div>

<script>
  function goHome(){ window.location.href = "/"; }

  function getUsername(){
    // Try query param first
    const url = new URL(window.location.href);
    const q = url.searchParams.get("username");
    if (q && q.trim()) return q.trim();

    // Then localStorage
    const a = localStorage.getItem("sh_username");
    if (a && a.trim()) return a.trim();

    const b = localStorage.getItem("username");
    if (b && b.trim()) return b.trim();

    return "";
  }

  function ensureUsername(){
    let u = getUsername();
    if (u) return u;

    u = prompt("Enter your name (for My Entries):");
    if (!u || !u.trim()) return "";
    u = u.trim();
    localStorage.setItem("sh_username", u);
    return u;
  }

  function renderEmpty(msg){
    document.getElementById("list").innerHTML = `
      <div class="card">
        <div style="font-weight:700;">No entries</div>
        <div class="muted">${msg || "You have not joined any pool yet."}</div>
        <div style="margin-top:10px;">
          <button class="btnSolid" onclick="goHome()">Go Join a Pool</button>
        </div>
      </div>
    `;
  }

  function openDraft(poolId, entryId){
    const params = new URLSearchParams();
    if (poolId) params.set("poolId", poolId);
    if (entryId) params.set("entryId", entryId);
    window.location.href = "/draft.html?" + params.toString();
  }

  async function load(){
    const username = ensureUsername();
    if (!username){
      renderEmpty("No username. Please go back and Join first.");
      return;
    }

    document.getElementById("userPill").textContent = "User: " + username;

    const res = await fetch("/api/my-entries?username=" + encodeURIComponent(username));
    const data = await res.json().catch(()=>null);

    if (!data || !data.ok){
      renderEmpty("API error. Check /api/my-entries.");
      return;
    }

    document.getElementById("modePill").textContent = "Mode: " + (data.mode || "-");

    const entries = data.entries || [];
    if (!entries.length){
      renderEmpty("0 entries found for " + username);
      return;
    }

    document.getElementById("list").innerHTML = entries.map(e => `
      <div class="card">
        <div class="row">
          <div>
            <div style="font-weight:700;">Pool: ${e.poolId}</div>
            <div class="small muted">Entry ID: ${e.id}</div>
            <div class="small muted">Created: ${e.createdAt || "-"}</div>
          </div>
          <div>
            <button class="btnSolid" onclick="openDraft('${e.poolId}','${e.id}')">Open Draft</button>
          </div>
        </div>
      </div>
    `).join("");
  }

  load();
</script>
</body>
</html>
